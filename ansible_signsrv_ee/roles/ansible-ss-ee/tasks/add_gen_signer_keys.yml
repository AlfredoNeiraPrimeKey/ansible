---

- name: Generate key for {{ item.name }}:{{ item.keyalias }} - {{ item.keyalg }}:{{ item.keysize }}
  command: "{{ signsrv_home }}/bin/signserver generatekey {{ item.workerid }} -keyalg {{ item.keyalg }} -keyspec {{ item.keysize }} -alias {{ item.keyalias }}"
  args:
    chdir: "{{ signsrv_home }}"
  environment:
    APPSRV_HOME: "{{ wildfly_home }}"
  become: yes
  become_user: "{{ signsrv_user }}"
  register: generate_p11_keys

- name: Genrate CSR for {{ item.name }}:{{ item.keyalias }}
  command: "{{ signsrv_home }}/bin/signserver generatecertreq  {{ item.workerid }} '{{ item.dn }}' {{ item.sig_alg }} /var/tmp/{{ item.name }} -alias {{ item.keyalias }}"
  args:
    chdir: "{{ signsrv_home }}"
  environment:
    APPSRV_HOME: "{{ wildfly_home }}"
  become: yes
  become_user: "{{ signsrv_user }}"
  register: generate_p11_keys

- name: Copy CSR for {{ item.name }}:{{ item.keyalias }} to localhost
  become: no
  fetch:
    src: "/var/tmp/{{ item.name }}"
    dest: "{{ ejbca_csr_dir_output }}/{{ item.name }}.csr"
    flat: yes

- name: Remove the CSR file {{ item.name }}.csr in /var/tmp
  file:
    path: "/var/tmp/{{ item.name }}"
    state: absent
  no_log: true
